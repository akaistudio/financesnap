<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Varnam Suite ‚Äî {{ selected.name }}</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--bg:#0B0F1A;--surface:#141926;--border:#2A3148;--text:#E8ECF4;--text2:#8B95B0;
--blue:#3B82F6;--green:#4ADE80;--red:#F87171;--orange:#FBBF24;--purple:#A78BFA}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.topbar{background:var(--surface);border-bottom:1px solid var(--border);padding:12px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.topbar h1{font-size:20px;font-weight:800;color:#fff}.topbar h1 span{background:linear-gradient(135deg,var(--blue),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.topbar-right{display:flex;align-items:center;gap:6px}
.topbar-right a{font-size:13px;color:var(--text2);text-decoration:none;padding:7px 12px;border-radius:8px;transition:.15s}
.topbar-right a:hover{background:var(--border);color:#fff}
.main{max-width:1200px;margin:0 auto;padding:24px}

/* Company bar */
.co-bar{display:flex;align-items:center;gap:14px;margin-bottom:24px;padding:14px 18px;background:var(--surface);border:1px solid var(--border);border-radius:14px}
.co-bar select{padding:10px 14px;background:var(--bg);border:1.5px solid var(--border);border-radius:8px;color:#fff;font-size:15px;font-weight:700;font-family:'DM Sans',sans-serif;cursor:pointer;min-width:220px}
.co-bar select:focus{outline:none;border-color:var(--blue)}
.co-bar select option{background:var(--surface)}
.co-bar .curr{padding:6px 12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;font-size:13px;font-weight:700;color:var(--orange)}
.co-bar .apps-used{display:flex;gap:6px;margin-left:auto}
.app-dot{padding:4px 10px;border-radius:6px;font-size:11px;font-weight:700;background:rgba(74,222,128,.1);color:var(--green);border:1px solid rgba(74,222,128,.2)}

/* Hero */
.hero{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:24px}
.hc{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:24px;position:relative;overflow:hidden;cursor:pointer;transition:.15s}
.hc:hover{border-color:var(--blue);transform:translateY(-2px)}
.hc::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.hc.rev::before{background:var(--green)}.hc.cost::before{background:var(--red)}.hc.prof::before{background:var(--blue)}
.hc .lab{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text2);margin-bottom:6px}
.hc .amt{font-size:30px;font-weight:800;color:#fff}
.hc .sub{font-size:13px;color:var(--text2);margin-top:4px}
.hc .amt.g{color:var(--green)}.hc .amt.r{color:var(--red)}.hc .amt.b{color:var(--blue)}

/* App launcher */
.launcher{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:24px}
.launch-btn{display:flex;flex-direction:column;align-items:center;gap:8px;padding:18px 12px;background:var(--surface);border:1px solid var(--border);border-radius:12px;text-decoration:none;transition:.15s;cursor:pointer}
.launch-btn:hover{border-color:var(--blue);transform:translateY(-2px)}
.launch-btn .icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:800;color:#fff}
.launch-btn .lname{font-size:12px;font-weight:600;color:var(--text2)}
.launch-btn .laction{font-size:11px;color:var(--blue);font-weight:700}
.launch-btn.inactive{opacity:.35;pointer-events:none}

.g2{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:24px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:20px}
.card h3{font-size:13px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:14px;display:flex;justify-content:space-between;align-items:center}
.card h3 a{color:var(--text2);text-decoration:none}.card h3 a:hover{color:var(--blue)}
.badge{font-size:11px;padding:3px 8px;border-radius:6px;background:var(--border);color:var(--text2);font-weight:600}
.sr{display:flex;justify-content:space-between;padding:9px 0;border-bottom:1px solid var(--border);font-size:13px}
.sr:last-child{border:none}.sr .l{color:var(--text2)}.sr .v{font-weight:700;color:var(--text)}
.sr .v.g{color:var(--green)}.sr .v.r{color:var(--red)}.sr .v.o{color:var(--orange)}.sr .v.b{color:var(--blue)}

/* Chart */
.chart{display:flex;align-items:flex-end;gap:8px;height:140px;padding-top:8px}
.cg{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px}
.cbars{display:flex;gap:2px;align-items:flex-end;height:110px}
.cb{width:16px;border-radius:3px 3px 0 0;min-height:2px;transition:.3s}
.cb.i{background:var(--green)}.cb.e{background:var(--red)}.cb.p{background:var(--orange)}
.clbl{font-size:11px;color:var(--text2);font-weight:600}
.legend{display:flex;gap:16px;margin-top:10px}.legend-i{display:flex;align-items:center;gap:5px;font-size:12px;color:var(--text2)}
.legend-d{width:10px;height:10px;border-radius:3px}

/* Category bars */
.cat{margin-bottom:10px}.cat .ch{display:flex;justify-content:space-between;font-size:13px;margin-bottom:3px}
.cat .ch .n{color:var(--text2)}.cat .ch .a{font-weight:700;color:var(--text)}
.cat-bar{width:100%;height:6px;background:var(--bg);border-radius:3px;overflow:hidden}
.cat-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--blue),var(--purple))}

/* Table */
table{width:100%;border-collapse:collapse}
th{padding:8px 10px;text-align:left;font-size:11px;font-weight:700;color:var(--text2);text-transform:uppercase;border-bottom:1px solid var(--border)}
td{padding:9px 10px;font-size:13px;color:var(--text);border-bottom:1px solid var(--border)}
.status{display:inline-block;padding:3px 8px;border-radius:10px;font-size:11px;font-weight:700}
.status.paid,.status.active,.status.accepted{background:rgba(74,222,128,.15);color:var(--green)}
.status.sent,.status.signed{background:rgba(59,130,246,.15);color:var(--blue)}
.status.draft{background:rgba(139,149,176,.12);color:var(--text2)}
.status.overdue{background:rgba(248,113,113,.15);color:var(--red)}
.empty{text-align:center;padding:24px;color:var(--text2);font-size:13px}
.flash{padding:12px;border-radius:10px;font-size:13px;margin-bottom:16px}
.flash.success{background:rgba(74,222,128,.1);color:var(--green);border:1px solid rgba(74,222,128,.2)}
.flash.error{background:rgba(248,113,113,.1);color:var(--red);border:1px solid rgba(248,113,113,.2)}
@media(max-width:768px){.hero,.g2,.g3,.launcher,.g3b{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="topbar">
    <a href="/apps" style="text-decoration:none"><h1>Snap<span>Suite</span></h1></a>
    <div class="topbar-right">
        <a href="/apps">üè† Apps</a>
        {% if user.is_superadmin %}<a href="/admin">üëë Admin</a>{% endif %}
        <a href="/settings">‚öôÔ∏è</a>
        <a href="/logout">Sign out</a>
    </div>
</div>
<div class="main">
{% with messages = get_flashed_messages(with_categories=true) %}{% for cat, msg in messages %}<div class="flash {{ cat }}">{{ msg }}</div>{% endfor %}{% endwith %}

<!-- Company Switcher -->
<div class="co-bar">
    <select onchange="location.href='/?company='+this.value">
        {% for c in companies %}<option value="{{ c.id }}" {% if c.id==selected.id %}selected{% endif %}>{{ c.name }}</option>{% endfor %}
    </select>
    <span class="curr">{{ selected.currency }}</span>
    <div class="apps-used">
        {% for an in apps %}<span class="app-dot">{{ an }}</span>{% endfor %}
    </div>
    <a href="/export/all?company={{ selected.id }}" style="margin-left:auto;padding:6px 14px;background:linear-gradient(135deg,#4ADE80,#14b8a6);color:#000;border-radius:8px;font-size:12px;font-weight:700;text-decoration:none">üì• Export All</a>
</div>

<!-- App Launcher -->
<div class="launcher">
    <a class="launch-btn {{ '' if 'ProposalSnap' in apps else 'inactive' }}" href="{{ app_urls.ProposalSnap }}{{ '/demo' if is_demo else '' }}" target="_blank">
        <div class="icon" style="background:linear-gradient(135deg,#f59e0b,#ea580c)">P</div>
        <span class="lname">ProposalSnap</span><span class="laction">Create Pitch ‚Üí</span>
    </a>
    <a class="launch-btn {{ '' if 'ContractSnap' in apps else 'inactive' }}" href="{{ app_urls.ContractSnap }}{{ '/demo' if is_demo else '' }}" target="_blank">
        <div class="icon" style="background:linear-gradient(135deg,#14b8a6,#0d9488)">C</div>
        <span class="lname">ContractSnap</span><span class="laction">New Contract ‚Üí</span>
    </a>
    <a class="launch-btn {{ '' if 'InvoiceSnap' in apps else 'inactive' }}" href="{{ app_urls.InvoiceSnap }}{{ '/demo' if is_demo else '' }}" target="_blank">
        <div class="icon" style="background:linear-gradient(135deg,#3b82f6,#2563eb)">I</div>
        <span class="lname">InvoiceSnap</span><span class="laction">Send Invoice ‚Üí</span>
    </a>
    <a class="launch-btn {{ '' if 'ExpenseSnap' in apps else 'inactive' }}" href="{{ app_urls.ExpenseSnap }}{{ '/demo' if is_demo else '' }}" target="_blank">
        <div class="icon" style="background:linear-gradient(135deg,#f87171,#dc2626)">E</div>
        <span class="lname">ExpenseSnap</span><span class="laction">Upload Receipt ‚Üí</span>
    </a>
    <a class="launch-btn {{ '' if 'PayslipSnap' in apps else 'inactive' }}" href="{{ app_urls.PayslipSnap }}{{ '/demo' if is_demo else '' }}" target="_blank">
        <div class="icon" style="background:linear-gradient(135deg,#a78bfa,#7c3aed)">$</div>
        <span class="lname">PayslipSnap</span><span class="laction">Run Payroll ‚Üí</span>
    </a>
</div>

<!-- P&L -->
<div class="hero">
    <div class="hc rev" onclick="location.href='/drilldown/invoices?company={{ selected.id }}'">
        <div class="lab">Revenue</div>
        <div class="amt g">{{ curr }}{{ "{:,.0f}".format(revenue) }}</div>
        <div class="sub">{{ curr }}{{ "{:,.0f}".format(total_paid) }} paid{% if total_unpaid > 0 %} ¬∑ {{ curr }}{{ "{:,.0f}".format(total_unpaid) }} unpaid{% endif %}</div>
    </div>
    <div class="hc cost" onclick="location.href='/drilldown/expenses?company={{ selected.id }}'">
        <div class="lab">Costs</div>
        <div class="amt r">{{ curr }}{{ "{:,.0f}".format(costs) }}</div>
        <div class="sub">{% if total_expenses > 0 %}{{ curr }}{{ "{:,.0f}".format(total_expenses) }} expenses (excl. payroll){% endif %}{% if total_payroll > 0 %} ¬∑ {{ curr }}{{ "{:,.0f}".format(total_payroll) }} payroll{% endif %}{% if costs == 0 %}No costs yet{% endif %}</div>
    </div>
    <div class="hc prof">
        <div class="lab">Net Profit</div>
        <div class="amt {{ 'g' if profit >= 0 else 'r' }}">{{ curr }}{{ "{:,.0f}".format(profit) }}</div>
        <div class="sub">{% if revenue > 0 %}{{ "{:.1f}".format(profit/revenue*100) }}% margin{% else %}‚Äî{% endif %}</div>
    </div>
</div>

<!-- Cash Flow + Revenue -->
<div class="g2">
    <div class="card">
        <h3>Monthly Cash Flow <span class="badge">Last 6 months</span></h3>
        <div class="chart">
            {% for m in monthly %}
            <div class="cg">
                <div class="cbars">
                    <div class="cb i" style="height:{{ (m.income/mcv*100)|int }}px"></div>
                    <div class="cb e" style="height:{{ (m.expense/mcv*100)|int }}px"></div>
                    <div class="cb p" style="height:{{ (m.payroll/mcv*100)|int }}px"></div>
                </div>
                <div class="clbl">{{ m.label[:3] }}</div>
            </div>
            {% endfor %}
        </div>
        <div class="legend">
            <div class="legend-i"><div class="legend-d" style="background:var(--green)"></div>Income</div>
            <div class="legend-i"><div class="legend-d" style="background:var(--red)"></div>Expenses</div>
            <div class="legend-i"><div class="legend-d" style="background:var(--orange)"></div>Payroll</div>
        </div>
    </div>
    <div class="card">
        <h3><a href="/drilldown/invoices?company={{ selected.id }}">Revenue Breakdown ‚Üó</a></h3>
        <div class="sr"><span class="l">Invoiced</span><span class="v">{{ curr }}{{ "{:,.0f}".format(total_invoiced) }}</span></div>
        <div class="sr"><span class="l">‚Ü≥ Paid</span><span class="v g">{{ curr }}{{ "{:,.0f}".format(total_paid) }}</span></div>
        <div class="sr"><span class="l">‚Ü≥ Unpaid</span><span class="v o">{{ curr }}{{ "{:,.0f}".format(total_unpaid) }}</span></div>
        <div class="sr"><span class="l">‚Ü≥ Overdue</span><span class="v r">{{ curr }}{{ "{:,.0f}".format(total_overdue) }}</span></div>
        <div style="border-top:1px solid var(--border);margin-top:6px;padding-top:6px">
            <div class="sr"><span class="l">Contract Value</span><span class="v b">{{ curr }}{{ "{:,.0f}".format(contract_value) }}</span></div>
        </div>
    </div>
</div>

<!-- Expenses + Payroll -->
<div class="g2">
    <div class="card">
        <h3><a href="/drilldown/expenses?company={{ selected.id }}">Expenses (excl. payroll) ‚Üó</a> <span class="badge">{{ curr }}{{ "{:,.0f}".format(total_expenses) }}</span></h3>
        {% if expense_cats %}
        {% set mx = expense_cats[0][1] if expense_cats else 1 %}
        {% for cat, amt in expense_cats %}
        <div class="cat"><div class="ch"><span class="n">{{ cat }}</span><span class="a">{{ curr }}{{ "{:,.0f}".format(amt) }}</span></div>
        <div class="cat-bar"><div class="cat-fill" style="width:{{ (amt/mx*100)|int }}%"></div></div></div>
        {% endfor %}
        {% else %}<div class="empty">No expenses yet</div>{% endif %}
    </div>
    <div class="card">
        <h3><a href="/drilldown/payroll?company={{ selected.id }}">Payroll ‚Üó</a> <span class="badge">{{ curr }}{{ "{:,.0f}".format(total_payroll) }}</span></h3>
        <div class="sr"><span class="l">Gross Salary</span><span class="v">{{ curr }}{{ "{:,.0f}".format(total_payroll_gross) }}</span></div>
        <div class="sr"><span class="l">Employer PF + ESI</span><span class="v o">{{ curr }}{{ "{:,.0f}".format(total_payroll - total_payroll_gross) }}</span></div>
        <div class="sr"><span class="l">Employer Cost (CTC)</span><span class="v r">{{ curr }}{{ "{:,.0f}".format(total_payroll) }}</span></div>
        <div class="sr"><span class="l">Net Payout</span><span class="v g">{{ curr }}{{ "{:,.0f}".format(total_payroll_net) }}</span></div>
    </div>
</div>

<!-- Proposals + Contracts + Invoices -->
<div class="g3b" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:12px">
    <div class="card">
        <h3><a href="/drilldown/proposals?company={{ selected.id }}">Proposals ‚Üó</a> <span class="badge">{{ proposals|length }}</span></h3>
        {% if proposals %}
        <table><thead><tr><th>Proposal</th><th>Value</th><th>Status</th></tr></thead><tbody>
        {% for p in proposals %}<tr><td><strong>{{ p.title[:30] }}{% if p.title|length > 30 %}‚Ä¶{% endif %}</strong><br><span style="font-size:11px;color:var(--text2)">{{ p.client or '' }}</span></td><td>{{ curr }}{{ "{:,.0f}".format(p.value or 0) }}</td><td><span class="status {{ p.status }}">{{ p.status|capitalize }}</span></td></tr>{% endfor %}
        </tbody></table>
        {% else %}<div class="empty">No proposals yet</div>{% endif %}
    </div>
    <div class="card">
        <h3><a href="/drilldown/contracts?company={{ selected.id }}">Contracts ‚Üó</a> <span class="badge">{{ contracts|length }}</span></h3>
        {% if contracts %}
        <table><thead><tr><th>Title</th><th>Value</th><th>Status</th></tr></thead><tbody>
        {% for c in contracts %}<tr><td><strong>{{ c.title[:35] }}</strong></td><td>{{ curr }}{{ "{:,.0f}".format(c.total_value or 0) }}</td><td><span class="status {{ c.status }}">{{ c.status|capitalize }}</span></td></tr>{% endfor %}
        </tbody></table>
        {% else %}<div class="empty">No contracts</div>{% endif %}
    </div>
    <div class="card">
        <h3><a href="/drilldown/invoices?company={{ selected.id }}">Invoices ‚Üó</a> <span class="badge">{{ invoices|length }}</span></h3>
        {% if invoices %}
        <table><thead><tr><th>Invoice</th><th>Amount</th><th>Status</th></tr></thead><tbody>
        {% for i in invoices %}<tr><td><strong>{{ i.invoice_number or '-' }}</strong><br><span style="font-size:11px;color:var(--text2)">{{ i.client_name or '' }}</span></td><td>{{ curr }}{{ "{:,.0f}".format(i.total or 0) }}</td><td><span class="status {{ i.status }}">{{ i.status|capitalize }}</span></td></tr>{% endfor %}
        </tbody></table>
        {% else %}<div class="empty">No invoices</div>{% endif %}
    </div>
</div>
</div>
</body></html>
